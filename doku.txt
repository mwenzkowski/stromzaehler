1. Benötigte Pakete installieren
================================

libcurl
-------
	sudo apt install libcurl4-openssl-dev

Benötigt zum kompilieren des eigenen Programms.

InfluxDB
---------

Installieren mit

	sudo apt-get install influxdb influxdb-client

In der Konfigurationsdatei /etc/influxdb/influxdb.conf die Zeilen
auskommentiern und/oder ändern:

	...
	reporting-enables = false
	...
	# Bind address to use for the RPC service for backup and restore.
	bind-address = "0.0.0.0:8088"
	...
	[http]
	...
	log-enabled = false
	...

Dann influxdb neustarten um die neue Konfiguration zu benutzen:

	sudo systemctl restart influxdb.service

Grafana
-------

Abhängigkeiten von Grafana installieren:

	sudo apt install adduser libfontconfig1

Grafana herunterladen und installieren:

	wget https://dl.grafana.com/oss/release/grafana-rpi_7.2.2_armhf.deb
	sudo dpkg -i grafana-rpi_7.2.2_armhf.deb

	(Dieses Paket ist für den Raspberry Pi 1. Pakete für andere Raspberry
	Pi's können auf https://grafana.com/grafana/download?platform=arm
	gefunden werden.)

Grafana aktivieren und starten:

	sudo systemctl daemon-reload
	sudo systemctl enable --now grafana-server


2. Datenbank erstellen
======================

	influx -execute 'CREATE DATABASE stromzaehler'


3. Tagesverbräuche autmatisch in Tabelle einfügen lassen
========================================================

Todo:
Prüfen ob es möglich ist die 'Continuous Query' zu erstellen ohne das die
Tabellen/Measurements auf die sich die Query bezieht schon existieren.

Um eine 'Continuous Query' zu erstellen, die nach jedem Tag den Tagesverbrauch
berechnet und in die Tabelle einfügt, wird

	influx -database stromzaehler

ausgeführt und in diesem Programm die Anfrage

	CREATE CONTINUOUS QUERY cq_tageszaehler ON stromzaehler
		BEGIN select difference(last("count"))
		INTO tageszaehler
		FROM stromzaehler
		GROUP BY time(1d) tz('Europe/Berlin')
	END

durchgeführt.

Gab es schon Werte bevor die 'Continuous Query' erstellt wurde können die
Tagesverbräuche dieser Werte mit folgendem Aufruf berechnet und in die Tabelle
'tageszaehler' eingefügt werden (Dies sollte nicht nötig sein, dies war nur
einmal erforderlich, da die 'Continuous Query' einige Tage nach der
Aufzeichnung erstellt wurde und diese die Tagesverbräuche nur für neue
abgeschlossene Tage berechnet).

	influx -database stromzaehler

starten und dann

	SELECT difference(last("count"))
	INTO tageszaehler
	FROM stromzaehler
	WHERE time >= '2019-10-18' AND time < '2019-10-29'
	GROUP BY time(1d) tz('Europe/Berlin')

ausführen (Die Zeiten natürlich anpassen).


4. Das Programm kompilieren
===========================

In dem Ordner in dem auch diese Doku-Datei liegt, das Programm

	make

ausführen. Dies kompiliert das Programm mit dem Namen 'stromzaehler'.


5. Das Programm automatisch nach dem Booten starten
===================================================

	sudo cp stromzaehler.service /etc/systemd/system/

Dann in der Datei /etc/systemd/system/stromzaehler.service den Pfad zum
Stromzähler-Programm anpassen wenn nötig. Dazu die Zeile

	ExecStart=/home/pi/stromzähler/stromzaehler

ändern.

Zum einlesen der neuen Service-Datei

	sudo systemctl daemon-reload

ausführen.

Zum aktivieren des Dienstes beim Booten und zum sofortigen starten

	sudo systemctl enable stromzaehler.service
	sudo systemctl start stromzaehler.service

ausführen. Ein Befehl der beides gleichzeitung macht ist

	
	sudo systemctl enable --now stromzaehler.service
